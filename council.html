<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Command | NAPPS Ogun</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { /* styles omitted for brevity - use same as provided */ }
        /* For full styles see the provided council template in the attachments */
    </style>
</head>
<body>
<!-- Council portal content copied from the provided template -->
<nav>
    <div class="nav-brand">
        <h2>NAPPS OGUN</h2>
        <p style="font-size: 0.6rem; letter-spacing: 4px; opacity: 0.6; margin-top: 5px; color: var(--gold-electric);">EXECUTIVE PORTAL</p>
    </div>
    <ul class="nav-links" id="navLinks"></ul>
    <button onclick="logout()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Terminate Session
    </button>
</nav>
<main>
    <div class="header-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="globalSearch" placeholder="Initiate global search protocol..." oninput="handleSearch()">
        </div>
        <div class="role-chip" id="roleTag">Officer</div>
    </div>

    <div id="connectionError" class="error-banner">
        <i class="fas fa-exclamation-triangle"></i>
        <span><b>Connection Severed:</b> Database Uplink Failed. Retrying...</span>
    </div>

    <div class="stats-grid" id="statsArea"></div>

    <div id="treasuryPanel" class="content-panel">
        <h3><i class="fas fa-coins" style="margin-right:10px; color:var(--gold-electric)"></i> Verification Queue</h3>
        <table>
            <thead><tr><th>School</th><th>ID Sequence</th><th>Fee</th><th>Asset</th><th>Command</th></tr></thead>
            <tbody id="treasuryBody"></tbody>
        </table>
    </div>

    <div id="proPanel" class="content-panel">
        <h3><i class="fas fa-photo-video" style="margin-right:10px; color:var(--gold-electric)"></i> Media Grid</h3>
        <div class="gallery-grid" id="proGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;"></div>
    </div>

    <div id="secretaryPanel" class="content-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--glass-border); padding-bottom:15px;">
            <h3 style="border:none; margin:0;">State Registry</h3>
            <button class="btn btn-verify" onclick="exportData()"><i class="fas fa-download"></i> Export CSV</button>
        </div>
        <table>
            <thead><tr><th>School Identity</th><th>Comm Link</th><th>Location Sector</th><th>Status</th></tr></thead>
            <tbody id="secretaryBody"></tbody>
        </table>
    </div>

    <div id="auditPanel" class="content-panel">
        <h3><i class="fas fa-fingerprint" style="margin-right:10px; color:var(--gold-electric)"></i> Security Log</h3>
        <table>
            <thead><tr><th>Timestamp</th><th>Officer</th><th>Protocol</th><th>Target ID</th></tr></thead>
            <tbody id="auditBody"></tbody>
        </table>
    </div>
</main>

<script>
    const API_PATH = '/.netlify/functions/api';
    const role = sessionStorage.getItem('council_role') || 'Treasurer';
    const passcode = sessionStorage.getItem('council_passcode') || '2024';
    let masterData = [];
    let filteredData = [];

    async function boot() {
        document.getElementById('roleTag').innerText = `CMD: ${role}`;
        setupMenu();
        await loadData();
        if (role === 'Secretary') loadLogs();
    }

    function setupMenu() {
        const menus = {
            'Treasurer': [
                {id: 'treasuryPanel', icon: 'fa-wallet', label: 'Fiscal Control'},
                {id: 'secretaryPanel', icon: 'fa-database', label: 'Master Registry'}
            ],
            'PRO': [
                {id: 'proPanel', icon: 'fa-camera-retro', label: 'Media Matrix'},
                {id: 'secretaryPanel', icon: 'fa-users', label: 'Registry View'}
            ],
            'Secretary': [
                {id: 'secretaryPanel', icon: 'fa-server', label: 'Registry Admin'},
                {id: 'auditPanel', icon: 'fa-shield-virus', label: 'Audit Trail'},
                {id: 'proPanel', icon: 'fa-eye', label: 'Asset Review'}
            ]
        };
        const activeMenu = menus[role] || menus['Treasurer'];
        document.getElementById('navLinks').innerHTML = activeMenu.map((m, i) => `
            <li onclick="switchPanel('${m.id}')" class="${i === 0 ? 'active' : ''}">
                <i class="fas ${m.icon}"></i> ${m.label}
            </li>
        `).join('');
        switchPanel(activeMenu[0].id);
    }

    async function loadData() {
        try {
            const res = await fetch(`${API_PATH}?type=schools`);
            const contentType = res.headers.get('content-type');
            if (!res.ok || (contentType && contentType.indexOf('application/json') === -1)) throw new Error('Server returned an error page.');
            masterData = await res.json();
            filteredData = [...masterData];
            document.getElementById('connectionError').style.display = 'none';
            refreshUI();
        } catch (e) {
            console.error('Sync Error:', e);
            document.getElementById('connectionError').style.display = 'flex';
        }
    }

    async function loadLogs() {
        try {
            const res = await fetch(`${API_PATH}?type=logs`);
            if (!res.ok) return;
            const logs = await res.json();
            document.getElementById('auditBody').innerHTML = logs.slice(0, 50).map(l => `
                <tr>
                    <td style="color:var(--text-muted); font-family:'Courier New', monospace;">${new Date(l.timestamp).toLocaleTimeString()}</td>
                    <td><strong style="color:white;">${l.actor}</strong></td>
                    <td><span style="color:${l.action === 'DELETE' ? '#ff6b6b' : '#00ff9d'}">${l.action}</span></td>
                    <td><code>${l.targetId ? l.targetId.substring(0,8) : 'N/A'}</code></td>
                </tr>
            `).join('');
        } catch (e) { console.log('Logs not available yet.'); }
    }

    function handleSearch() {
        const query = document.getElementById('globalSearch').value.toLowerCase();
        filteredData = masterData.filter(s => (s.school || '').toLowerCase().includes(query) || (s.location || '').toLowerCase().includes(query) || (s.id || '').includes(query));
        refreshUI();
    }

    function refreshUI() {
        renderStats();
        const pending = filteredData.filter(s => s.receipt && s.status !== 'verified');
        const tBody = document.getElementById('treasuryBody');
        if (pending.length === 0) {
            tBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">ALL SYSTEMS NOMINAL. NO QUEUE.</td></tr>';
        } else {
            tBody.innerHTML = pending.map(s => `
                <tr>
                    <td style="font-weight:600; color:white;">${s.school}</td>
                    <td><code style="color:var(--gold-electric)">${(s.id||'').substring(0,8)}</code></td>
                    <td style="color:var(--text-muted)">₦5,000</td>
                    <td><button class="btn btn-ghost" onclick="viewImg('${s.receipt}')">INSPECT</button></td>
                    <td><button class="btn btn-verify" onclick="act('${s.id}', 'verify')">AUTHORIZE</button></td>
                </tr>
            `).join('');
        }

        document.getElementById('proGrid').innerHTML = filteredData.map(s => `
            <div style="border-radius:12px; overflow:hidden; border:1px solid var(--glass-border); background:rgba(255,255,255,0.05); position:relative; transition:0.3s; cursor:pointer;" onmouseover="this.style.borderColor='var(--gold-electric)'" onmouseout="this.style.borderColor='var(--glass-border)'">
                <img src="${s.image || 'https://via.placeholder.com/200'}" style="width:100%; height:140px; object-fit:cover; opacity:0.8;">
                <div style="padding:15px;">
                    <strong style="display:block; color:white; font-size:0.8rem; margin-bottom:5px;">${(s.school||'').substring(0,20)}</strong>
                    <div style="font-size:0.6rem; letter-spacing:1px; color:${s.status === 'verified' ? '#00ff9d' : '#ffaa00'}">${(s.status||'').toUpperCase()}</div>
                </div>
            </div>
        `).join('');

        document.getElementById('secretaryBody').innerHTML = filteredData.map(s => `
            <tr>
                <td style="color:white; font-weight:600;">${s.school}</td>
                <td style="color:var(--text-muted);">${s.phone}</td>
                <td style="color:var(--text-muted);">${s.location || 'N/A'}</td>
                <td><span style="font-size:0.6rem; padding:4px 10px; border-radius:4px; background:${s.status === 'verified' ? 'rgba(0, 255, 157, 0.1)' : 'rgba(255, 170, 0, 0.1)'}; color:${s.status === 'verified' ? '#00ff9d' : '#ffaa00'}; border:1px solid ${s.status === 'verified' ? '#00ff9d' : '#ffaa00'};">${(s.status||'').toUpperCase()}</span></td>
            </tr>
        `).join('');
    }

    function renderStats() {
        const area = document.getElementById('statsArea');
        const vCount = masterData.filter(s => s.status === 'verified').length;
        let html = '';
        html = `
            <div class="stat-card"><p>VERIFIED REVENUE</p><h3>₦${(vCount * 5000).toLocaleString()}</h3></div>
            <div class="stat-card"><p>TOTAL SCHOOLS</p><h3>${masterData.length}</h3></div>
        `;
        area.innerHTML = html;
    }

    async function act(id, action) {
        if (!confirm(`Confirm Protocol: ${action.toUpperCase()}?`)) return;
        try {
            await fetch(API_PATH, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${passcode}` },
                body: JSON.stringify({ type: 'schools', action, id, actorRole: role })
            });
            await loadData();
            if (role === 'Secretary') loadLogs();
        } catch (e) { alert('Sync Failure. Check Connection.'); }
    }

    function exportData() {
        let csv = 'School Name,Phone,Location,Status\n';
        masterData.forEach(s => {
            csv += `${s.school},${s.phone},${s.location || 'N/A'},${s.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `NAPPS_Registry_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    function switchPanel(id) {
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-links li').forEach(li => li.classList.remove('active'));
        if (event && event.currentTarget) event.currentTarget.classList.add('active');
    }

    function viewImg(url) {
        const m = document.createElement('div');
        m.style = 'position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:999; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(10px);';
        m.innerHTML = `<img src="${url}" style="max-width:90%; max-height:80vh; border-radius:4px; box-shadow:0 0 50px rgba(255,215,0,0.2); border:1px solid var(--gold-electric);">`;
        m.onclick = () => m.remove();
        document.body.appendChild(m);
    }

    function logout() { sessionStorage.clear(); window.location.href = 'council.html'; }
    boot();
</script>
</body>
</html>