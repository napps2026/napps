<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Upload | NAPPS Ogun Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --napps-green: #004d2c; --gold: #d4af37; --bg: #f4f7f6; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .upload-container { max-width: 600px; margin: 50px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header i { color: var(--gold); font-size: 3rem; margin-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--napps-green); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        
        .btn-submit { background: var(--napps-green); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-submit:hover { background: #00361f; transform: translateY(-2px); }
        
        .preview-box { width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fafafa; }
        .preview-box img { max-width: 100%; max-height: 100%; object-fit: cover; }
        
        .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="upload-container">
    <div class="header">
        <i class="fas fa-images"></i>
        <h2 style="color: var(--napps-green); margin: 0;">PRO Gallery Upload</h2>
        <p>Add new memories to the Association Gallery</p>
    </div>

    <form id="uploadForm">
        <div class="form-group">
            <label>Event Title</label>
            <input type="text" id="title" placeholder="e.g., 2026 Annual Conference" required>
        </div>

        <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="imageUrl" placeholder="Paste image link here (Unsplash, Cloudinary, etc.)" oninput="updatePreview(this.value)" required>
        </div>

        <div class="preview-box" id="previewContainer">
            <span style="color: #ccc;">Image Preview will appear here</span>
        </div>

        <div class="form-group" style="margin-top:20px;">
            <label>Short Caption</label>
            <textarea id="caption" rows="3" placeholder="Describe the moment..."></textarea>
        </div>

        <div class="form-group">
            <label>Admin Access Key</label>
            <input type="password" id="adminKey" placeholder="Enter your Executive Key" required>
        </div>

        <button type="submit" class="btn-submit">POST TO GALLERY</button>
    </form>
    
    <a href="executive.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
</div>
async function handleFormSubmit() {
    const fileInput = document.getElementById('imageFile');
    const nameInput = document.getElementById('schoolName');
    const authKey = document.getElementById('masterKey').value; // For Executives
    
    if (!fileInput.files[0]) return alert("Please select an image first!");

    try {
        // --- STEP 1: CONVERT IMAGE TO BASE64 ---
        const file = fileInput.files[0];
        const base64Data = await toBase64(file);

        // --- STEP 2: CALL UPLOAD-IMAGE.JS (The Vault) ---
        console.log("Uploading image to S3...");
        const uploadRes = await fetch('/.netlify/functions/upload-image', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authKey}` 
            },
            body: JSON.stringify({
                fileName: file.name,
                data: base64Data
            })
        });

        const uploadResult = await uploadRes.json();
        if (!uploadRes.ok) throw new Error(uploadResult.error || "Upload failed");

        const imageUrl = uploadResult.url; // This is the link from AWS S3
        console.log("Image saved at:", imageUrl);

        // --- STEP 3: CALL API.JS (The Brain) ---
        console.log("Saving data to Database...");
        const apiRes = await fetch('/.netlify/functions/api', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authKey}`
            },
            body: JSON.stringify({
                type: 'schools',
                action: 'register',
                data: {
                    name: nameInput.value,
                    location: document.getElementById('location').value,
                    phone: document.getElementById('phone').value,
                    image_url: imageUrl, // Passing the S3 link here!
                    status: 'pending'
                }
            })
        });

        if (apiRes.ok) {
            alert("Success! School registered and image archived.");
            window.location.reload();
        }

    } catch (err) {
        console.error(err);
        alert("Process failed: " + err.message);
    }
}

// Helper to convert file to string
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});



</body>
</html>