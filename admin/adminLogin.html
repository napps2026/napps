<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Terminal | NAPPS Ogun</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (CSS shared previously - keeping the Sidebar and Table styles) */
        :root { --sidebar: #051a13; --accent: #c5a028; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; height: 100vh; margin: 0; }
        .sidebar { width: 260px; background: var(--sidebar); color: white; padding: 30px 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; overflow-y: auto; padding: 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        .table-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; font-size: 0.75rem; color: #888; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .badge { padding: 4px 10px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; }
        .badge-pending { background: #fff4e5; color: #d35400; }
        .badge-verified { background: #e6f4ea; color: #27ae60; }
        .btn-approve { background: var(--sidebar); color: var(--accent); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <script>
        // Security Check
        if(sessionStorage.getItem("napps_auth") !== "true") window.location.href = "admin-login.html";
    </script>

    <div class="sidebar">
        <h2 style="color: var(--accent); margin-bottom: 40px;">NAPPS OGUN</h2>
        <a href="#" style="color: white; text-decoration: none; margin-bottom: 20px;"><i class="fas fa-home"></i> Overview</a>
        <a href="#" style="color: rgba(255,255,255,0.6); text-decoration: none; margin-bottom: 20px;"><i class="fas fa-users"></i> Member Schools</a>
        <div style="margin-top: auto;">
            <p style="font-size: 0.6rem; opacity: 0.5;">POWERED BY</p>
            <p style="color: var(--accent); font-weight: 800; font-size: 0.8rem;">ATMOSPHERE DIGITAL</p>
        </div>
    </div>

    <div class="main-content">
        <h2>Secretariat Dashboard</h2>
        
        <div class="table-container" style="margin: 20px 0; height: 250px;">
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h5>Applications</h5><div id="count" style="font-size: 1.5rem; font-weight: 700;">0</div></div>
            <div class="stat-card"><h5>Pending</h5><div id="pending" style="font-size: 1.5rem; font-weight: 700; color: #d35400;">0</div></div>
            <div class="stat-card"><h5>Revenue (₦)</h5><div id="revenue" style="font-size: 1.5rem; font-weight: 700; color: #27ae60;">0</div></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th>School Name</th><th>LGA</th><th>Payment Proof</th><th>Status</th><th>Action</th></tr>
                </thead>
                <tbody id="appTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            // Live API call to your Netlify function
            const res = await fetch('/.netlify/functions/api?type=admin_get_all');
            const data = await res.json();
            
            const tbody = document.getElementById('appTable');
            tbody.innerHTML = '';
            let totalRev = 0;
            let pending = 0;

            data.forEach(app => {
                if(app.status === 'verified') totalRev += 50000;
                if(app.status === 'pending') pending++;

                tbody.innerHTML += `
                    <tr>
                        <td><b>${app.name}</b></td>
                        <td>${app.lga}</td>
                        <td><a href="${app.receipt_url}" target="_blank" style="color: blue;">View Receipt</a></td>
                        <td><span class="badge badge-${app.status}">${app.status}</span></td>
                        <td>
                            ${app.status === 'pending' ? `<button class="btn-approve" onclick="approve('${app.regId}')">Approve</button>` : '✅'}
                        </td>
                    </tr>
                `;
            });

            document.getElementById('count').innerText = data.length;
            document.getElementById('pending').innerText = pending;
            document.getElementById('revenue').innerText = totalRev.toLocaleString();
            
            initChart(data);
        }

        async function approve(id) {
            if(!confirm("Verify payment for this school?")) return;
            await fetch('/.netlify/functions/api', {
                method: 'POST',
                body: JSON.stringify({ type: 'approve', id: id })
            });
            loadDashboard();
        }

        function initChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Collections (₦)',
                        data: [150000, 450000, 300000, 800000], // Mock for visual, map real data here
                        borderColor: '#c5a028',
                        tension: 0.3
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>