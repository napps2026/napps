<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Portal | NAPPS Ogun</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --napps-green: #004d2c; --gold: #d4af37; --bg: #f0f2f5; --danger: #ff7675; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); margin: 0; }
        
        #authOverlay { position: fixed; inset: 0; background: var(--napps-green); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        header { background: var(--napps-green); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: white; position: sticky; top: 0; z-index: 1000; }
        .role-tag { background: var(--gold); color: var(--napps-green); padding: 5px 12px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        
        .container { padding: 30px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; transition: 0.3s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); }
        .preview-box { width: 100%; height: 200px; background: #222; overflow: hidden; cursor: zoom-in; position: relative; }
        .preview-box img { width: 100%; height: 100%; object-fit: contain; }
        .img-label { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; }

        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; transition: 0.2s; }
        .btn-verify { background: var(--napps-green); color: var(--gold); }
        .btn-delete { background: #fff1f1; color: var(--danger); margin-top: 8px; font-size: 0.8rem; }
        
        .tab-switcher { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border-radius: 20px; border: 1px solid var(--napps-green); cursor: pointer; font-weight: 600; background: white; color: var(--napps-green); white-space: nowrap; }
        .tab-btn.active { background: var(--napps-green); color: white; }

        .hidden { display: none !important; }
        .loader { text-align: center; padding: 50px; font-weight: 600; color: var(--napps-green); }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="login-card">
            <h2 style="color: var(--napps-green); margin-bottom: 5px;">OFFICER LOGIN</h2>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">OGUN SECURE TERMINAL</p>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="execKey" placeholder="Enter Security Key" required style="width:100%; padding:14px; margin-bottom:20px; border:2px solid #eee; border-radius:10px; box-sizing:border-box; text-align: center; font-size: 1.1rem;">
                <button type="submit" class="btn" style="background:var(--gold); color: var(--napps-green);">UNLOCK TOOLS</button>
            </form>
        </div>
    </div>

    <div id="mainDashboard" class="hidden">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-shield-halved" style="color: var(--gold);"></i>
                <h3 style="margin: 0; font-size: 1rem; letter-spacing: 1px;">NAPPS OGUN ADMIN</h3>
            </div>
            <div>
                <span id="displayRole" class="role-tag">OFFICER</span>
                <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer; margin-left:15px; font-weight: 700;">Logout</button>
            </div>
        </header>

        <div class="container">
            <div id="adminControls" class="tab-switcher hidden">
                <button class="tab-btn active" onclick="switchTab('all_schools', this)">School Requests</button>
                <button class="tab-btn" onclick="switchTab('admin_teachers', this)">Teacher Profiles</button>
            </div>

            <h2 id="welcomeText" style="color: var(--napps-green);">Reviewing Queue</h2>
            <div id="dataGrid" class="grid">
                <div class="loader">Accessing Registry...</div>
            </div>
        </div>
    </div>

    <script>
        let USER_KEY = "";
        let USER_ROLE = "";
        let CURRENT_TYPE = "all_schools";

        async function handleLogin(e) {
            if(e) e.preventDefault();
            USER_KEY = document.getElementById('execKey').value.trim();
            if(!USER_KEY) return;

            const k = USER_KEY.toLowerCase();
            if(k.includes("pro")) USER_ROLE = "PRO";
            else if(k.includes("treasurer") || k.includes("cash")) USER_ROLE = "TREASURER";
            else if(k.includes("sec")) USER_ROLE = "SECRETARY";
            else USER_ROLE = "PRESIDENT";

            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('displayRole').innerText = USER_ROLE;

            // Privilege-based navigation
            if(USER_ROLE === "PRESIDENT" || USER_ROLE === "SECRETARY") {
                document.getElementById('adminControls').classList.remove('hidden');
            }
            
            if(USER_ROLE === "PRO") CURRENT_TYPE = "admin_teachers";
            
            fetchExecutiveData();
        }

        function switchTab(type, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            CURRENT_TYPE = type;
            fetchExecutiveData();
        }

        async function fetchExecutiveData() {
            const grid = document.getElementById('dataGrid');
            grid.innerHTML = `<div class="loader"><i class="fas fa-spinner fa-spin"></i> Loading ${CURRENT_TYPE.replace('all_','').replace('admin_','')}...</div>`;
            
            try {
                const response = await fetch(`/.netlify/functions/api?type=${CURRENT_TYPE}`, {
                    headers: { 'Authorization': `Bearer ${USER_KEY}` }
                });
                
                if(!response.ok) throw new Error("Unauthorized");
                const data = await response.json();
                
                // PRESIDENT sees all history, others see only 'pending'
                const items = (USER_ROLE === "PRESIDENT") ? data : data.filter(item => item.status === 'pending');
                renderCards(items, CURRENT_TYPE);
            } catch (err) {
                grid.innerHTML = `<div class="loader" style="color:red;">Access Denied. Please check your Security Key.</div>`;
            }
        }

        function renderCards(items, type) {
            const grid = document.getElementById('dataGrid');
            if(!items || items.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><h3>No Pending items in this section</h3></div>`;
                return;
            }

            grid.innerHTML = items.map(item => {
                // Determine logic: Treasurers need to see the RECEIPT primarily
                const isTreasurer = USER_ROLE === 'TREASURER';
                const mainImg = (isTreasurer && item.receipt_url) ? item.receipt_url : (item.image_url || item.receipt_url);
                const label = (isTreasurer && item.receipt_url) ? "PAYMENT PROOF" : "LOGO/PHOTO";
                
                return `
                <div class="card">
                    <div class="preview-box" onclick="window.open('${mainImg}')">
                        <img src="${mainImg}" onerror="this.src='https://placehold.co/400x300?text=No+Image+Provided'">
                        <span class="img-label">${label}</span>
                    </div>
                    <div style="padding:20px; flex-grow: 1;">
                        <span class="role-tag" style="background:#f0f0f0; color:#555; margin-bottom:10px; display:inline-block">${item.status}</span>
                        <h4 style="margin: 5px 0; color: var(--napps-green);">${item.name}</h4>
                        <p style="font-size:0.75rem; color: #666; margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> ${item.location || item.qualification || item.email || 'N/A'}
                        </p>
                    </div>
                    <div style="padding: 0 20px 20px 20px;">
                        ${item.status === 'pending' ? `
                            <button onclick="updateStatus('${item.id}', '${type}', 'verify')" class="btn btn-verify">
                                <i class="fas fa-check-circle"></i> VERIFY & APPROVE
                            </button>
                        ` : '<div style="color:var(--napps-green); font-weight:700; text-align:center;"><i class="fas fa-check"></i> VERIFIED</div>'}

                        ${USER_ROLE === 'PRESIDENT' ? `
                            <button onclick="updateStatus('${item.id}', '${type}', 'delete')" class="btn btn-delete">
                                <i class="fas fa-trash-alt"></i> PERMANENT DELETE
                            </button>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        async function updateStatus(id, type, action) {
            if(!confirm(`Are you sure you want to ${action} this record?`)) return;
            
            // CLEAN THE TYPE for the API Security Guard
            const cleanType = type.replace('admin_', '').replace('all_', '');

            try {
                const res = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${USER_KEY}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ action: action, type: cleanType, id: id })
                });
                
                const result = await res.json();

                if(res.ok) {
                    alert("Update Successful!");
                    fetchExecutiveData();
                } else {
                    alert("Denied: " + (result.error || "Insufficient Permissions"));
                }
            } catch (e) {
                alert("Connection error. Check your network.");
            }
        }
    </script>
</body>
</html>